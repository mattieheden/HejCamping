@model HejCamping.Models.BookingModel

@{
    ViewData["Title"] = "Book a Campsite";
    var campsites = ViewBag.Campsites as List<HejCamping.Models.Campsite>; 
}

<h2 style="margin-top: 100px; text-align: center;">Choose your campsite and date</h2>

<div class="d-flex justify-content-between align-items-start mt-4" style="gap: 20px;">
    
    <!-- Date Picker -->
    <div style="max-width: 300px;">
        <div class="form-group">
            <label for="dt1">From date</label>
            <input type="text" id="dt1" class="form-control" value="@Model.FromDate.ToString("yyyy-MM-dd")" />
        </div>
        <div class="form-group mt-2">
            <label for="dt2">To date</label>
            <input type="text" id="dt2" class="form-control" value="@Model.ToDate.ToString("yyyy-MM-dd")" />
        </div>
    </div>

    <!-- Campsite Map -->
    <div style="flex: 2; position: relative;">
        <img src="~/images/campsite_map.png" alt="Campsite Map" style="width: 100%; max-width: 500px; border-radius: 15px;" id="campsiteMapImage"/>
        @foreach (var campsite in campsites)
        {
            var color = campsite.IsVacant ? "blue" : "red";
            <div id="campsite-@campsite.Id" 
                style="position: absolute; 
                        top: @(campsite.PositionY)px; 
                        left: @(campsite.PositionX)px; 
                        width: 30px; height: 30px; 
                        background-color: @color; 
                        color: white; 
                        display: flex; 
                        justify-content: center; 
                        align-items: center; 
                        font-weight: bold; 
                        cursor: pointer; 
                        border-radius: 8px;"  
                onclick="selectCampsite(@campsite.Id, @campsite.IsVacant.ToString().ToLower())">
                @campsite.Number
            </div>
        }
    </div>
</div>

<!-- Booking Form -->
<form id="bookingForm" asp-action="SubmitBooking" method="post" style="margin-top: 20px;">
    <input type="hidden" id="selectedCampsiteId" name="CampsiteId" value="" />
    <input type="hidden" id="selectedFromDateInput" name="FromDate" value="" />
    <input type="hidden" id="selectedToDateInput" name="ToDate" value="" />

    <div class="form-group">
        <label for="Name">Name</label>
        <input type="text" class="form-control narrow-input" id="Name" name="Name" required />
    </div>
    <div class="form-group">
        <label for="Email">Email</label>
        <input type="email" class="form-control narrow-input" id="Email" name="Email" required />
    </div>
    <button type="submit" class="btn btn-primary">Book</button>
</form>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script>
        $(document).ready(function () {
            // Initialize the date picker
            $('#dt1').datepicker({
                format: 'yyyy-mm-dd',
                autoclose: true,
                todayHighlight: true
            });

            $('#dt2').datepicker({
                format: 'yyyy-mm-dd',
                autoclose: true,
                todayHighlight: true
            });

            let selectedCampsiteId = null;

            window.selectCampsite = function(campsiteId, isVacant) {
                console.log("Campsite ID:", campsiteId, "Is Vacant:", isVacant);

                if (selectedCampsiteId !== null) {
                    // Reset the previously selected campsite color
                    document.getElementById('campsite-' + selectedCampsiteId).style.backgroundColor = "blue";
                }

                // Only change the color if the campsite is vacant
                if (isVacant) {
                    document.getElementById('campsite-' + campsiteId).style.backgroundColor = "green";
                    selectedCampsiteId = campsiteId;

                    // Store the selected campsite ID in the hidden form field
                    document.getElementById('selectedCampsiteId').value = campsiteId;
                } else {
                    alert("This campsite is not available.");
                }
            };

            document.getElementById('bookingForm').addEventListener('submit', function() {
                // Capture the selected date and store it in the hidden input before submitting
                var selectedFromDate = document.getElementById('dt1').value;
                var selectedToDate = document.getElementById('dt2').value;
                document.getElementById('selectedFromDateInput').value = selectedFromDate;
                document.getElementById('selectedToDateInput').value = selectedToDate;
            });
        });
    </script>
}
